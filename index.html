import React, { useState, useEffect, useRef } from 'react';
import { Download, RefreshCw, Clock, User, GraduationCap, Calendar } from 'lucide-react';

const App = () => {
  const [studentName, setStudentName] = useState('');
  const [grade, setGrade] = useState('4º');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [selectedAnswers, setSelectedAnswers] = useState({});
  const [showResult, setShowResult] = useState(false);
  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(30 * 60); // 30 minutes in seconds
  const [testStarted, setTestStarted] = useState(false);
  const [testCompleted, setTestCompleted] = useState(false);
  const timerRef = useRef(null);

  // Question bank - more than 10 questions for variety
  const questionBank = [
    {
      id: 1,
      question: "En un proyecto de upcycling de botellas plásticas, ¿qué representa una FORTALEZA en el análisis DOFA?",
      options: [
        "La facilidad para encontrar botellas plásticas usadas",
        "La competencia de otras empresas recicladoras",
        "La falta de conocimiento sobre técnicas de upcycling",
        "Las regulaciones ambientales restrictivas"
      ],
      correctAnswer: 0,
      evidence: "Realiza un análisis DOFA para evaluar las fortalezas, oportunidades, debilidades y amenazas de la solución.",
      explanation: "La facilidad para encontrar materiales (botellas plásticas) es una fortaleza interna positiva del proyecto de upcycling."
    },
    {
      id: 2,
      question: "¿Cuál de las siguientes es una OPORTUNIDAD para un proyecto de upcycling de ropa vieja?",
      options: [
        "La creciente conciencia ambiental de la comunidad",
        "La dificultad para coser prendas",
        "La falta de espacio para trabajar",
        "La competencia con tiendas de ropa nueva"
      ],
      correctAnswer: 0,
      evidence: "Realiza un análisis DOFA para evaluar las fortalezas, oportunidades, debilidades y amenazas de la solución.",
      explanation: "La creciente conciencia ambiental es un factor externo positivo que puede beneficiar el proyecto de upcycling."
    },
    {
      id: 3,
      question: "En un análisis DOFA para upcycling de neumáticos usados, ¿qué representa una AMENAZA?",
      options: [
        "La alta creatividad del equipo",
        "Las nuevas leyes que prohíben el uso de neumáticos en proyectos escolares",
        "La habilidad para cortar neumáticos",
        "La disponibilidad de herramientas adecuadas"
      ],
      correctAnswer: 1,
      evidence: "Realiza un análisis DOFA para evaluar las fortalezas, oportunidades, debilidades y amenazas de la solución.",
      explanation: "Las leyes restrictivas son factores externos negativos que amenazan la viabilidad del proyecto."
    },
    {
      id: 4,
      question: "¿Por qué es importante investigar estudios académicos al proponer un proyecto de upcycling de residuos electrónicos?",
      options: [
        "Para copiar exactamente lo que otros han hecho",
        "Para fundamentar científicamente los beneficios ambientales y técnicos de la propuesta",
        "Porque es más fácil que pensar en ideas propias",
        "Para hacer el proyecto más complicado"
      ],
      correctAnswer: 1,
      evidence: "Justifica su propuesta a través de una base investigativa, que incluye tanto estudios académicos como información de actualidad.",
      explanation: "Los estudios académicos proporcionan evidencia científica que respalda la efectividad y beneficios del upcycling de residuos electrónicos."
    },
    {
      id: 5,
      question: "Al justificar un proyecto de upcycling de periódicos viejos, ¿qué tipo de información de actualidad sería más relevante?",
      options: [
        "Estadísticas recientes sobre la cantidad de papel que se desperdicia en la escuela",
        "Noticias sobre películas populares",
        "Información sobre el clima de hace 10 años",
        "Datos sobre la producción de plástico en otros países"
      ],
      correctAnswer: 0,
      evidence: "Justifica su propuesta a través de una base investigativa, que incluye tanto estudios académicos como información de actualidad.",
      explanation: "Las estadísticas actuales sobre desperdicio de papel demuestran la necesidad y relevancia del proyecto de upcycling."
    },
    {
      id: 6,
      question: "En un proyecto de upcycling de latas de aluminio, ¿qué constituye una DEBILIDAD?",
      options: [
        "La abundancia de latas disponibles",
        "La dificultad para cortar y manipular el aluminio sin herramientas adecuadas",
        "El apoyo de la comunidad",
        "Las tendencias actuales de reciclaje"
      ],
      correctAnswer: 1,
      evidence: "Realiza un análisis DOFA para evaluar las fortalezas, oportunidades, debilidades y amenazas de la solución.",
      explanation: "La dificultad para manipular materiales sin herramientas adecuadas es una limitación interna del proyecto."
    },
    {
      id: 7,
      question: "¿Cuál es el propósito principal de realizar un análisis DOFA en un proyecto de upcycling escolar?",
      options: [
        "Hacer que el proyecto parezca más profesional",
        "Identificar estratégicamente los aspectos positivos y negativos internos y externos para mejorar la propuesta",
        "Cumplir con un requisito burocrático",
        "Impresionar a los compañeros de clase"
      ],
      correctAnswer: 1,
      evidence: "Realiza un análisis DOFA para evaluar las fortalezas, oportunidades, debilidades y amenazas de la solución.",
      explanation: "El análisis DOFA permite una evaluación estratégica completa que ayuda a fortalecer y mejorar la propuesta de upcycling."
    },
    {
      id: 8,
      question: "Al investigar para justificar un proyecto de upcycling de cartón, ¿qué combinación de fuentes es más efectiva?",
      options: [
        "Solo artículos de revistas de moda",
        "Estudios científicos sobre reciclaje combinados con datos actuales de consumo de cartón en la escuela",
        "Opiniones de celebridades sobre el medio ambiente",
        "Recetas de cocina relacionadas con reciclaje"
      ],
      correctAnswer: 1,
      evidence: "Justifica su propuesta a través de una base investigativa, que incluye tanto estudios académicos como información de actualidad.",
      explanation: "La combinación de fundamentos científicos y datos actuales locales crea una justificación sólida y relevante."
    },
    {
      id: 9,
      question: "En un análisis DOFA para upcycling de tapas plásticas, ¿qué representa una FORTALEZA?",
      options: [
        "La creatividad del estudiante para transformar las tapas en objetos útiles",
        "La competencia de empresas grandes",
        "Las restricciones presupuestarias",
        "La falta de interés de la comunidad"
      ],
      correctAnswer: 0,
      evidence: "Realiza un análisis DOFA para evaluar las fortalezas, oportunidades, debilidades y amenazas de la solución.",
      explanation: "La creatividad es una fortaleza interna positiva que diferencia y fortalece el proyecto de upcycling."
    },
    {
      id: 10,
      question: "¿Qué tipo de información de actualidad respaldaría mejor un proyecto de upcycling de residuos orgánicos?",
      options: [
        "Datos recientes sobre la cantidad de residuos orgánicos generados en la cafetería escolar",
        "Noticias sobre deportes internacionales",
        "Información histórica sobre la Revolución Industrial",
        "Estadísticas sobre el uso de internet"
      ],
      correctAnswer: 0,
      evidence: "Justifica su propuesta a través de una base investigativa, que incluye tanto estudios académicos como información de actualidad.",
      explanation: "Los datos actuales sobre residuos orgánicos escolares demuestran la necesidad inmediata y local del proyecto."
    },
    {
      id: 11,
      question: "En un proyecto de upcycling de envases de yogurt, ¿qué constituye una AMENAZA externa?",
      options: [
        "La habilidad manual del estudiante",
        "Nuevas regulaciones sanitarias que prohíben el reuso de envases alimenticios",
        "La disponibilidad de pinturas para decorar",
        "El entusiasmo del grupo de trabajo"
      ],
      correctAnswer: 1,
      evidence: "Realiza un análisis DOFA para evaluar las fortalezas, oportunidades, debilidades y amenazas de la solución.",
      explanation: "Las regulaciones sanitarias restrictivas son amenazas externas que pueden impedir la implementación del proyecto."
    },
    {
      id: 12,
      question: "¿Por qué es importante incluir información de actualidad al justificar un proyecto de upcycling de bolsas plásticas?",
      options: [
        "Para demostrar que el problema del plástico es actual y relevante en la comunidad",
        "Porque suena más moderno",
        "Para hacer el informe más largo",
        "Porque es un requisito arbitrario"
      ],
      correctAnswer: 0,
      evidence: "Justifica su propuesta a través de una base investigativa, que incluye tanto estudios académicos como información de actualidad.",
      explanation: "La información de actualidad demuestra que el problema abordado es contemporáneo y tiene impacto real en la comunidad."
    },
    {
      id: 13,
      question: "En un análisis DOFA para upcycling de cajas de cartón, ¿qué representa una OPORTUNIDAD?",
      options: [
        "La temporada de compras navideñas donde se generan más cajas",
        "La dificultad para encontrar pegamento",
        "La falta de espacio de almacenamiento",
        "La competencia con otros proyectos escolares"
      ],
      correctAnswer: 0,
      evidence: "Realiza un análisis DOFA para evaluar las fortalezas, oportunidades, debilidades y amenazas de la solución.",
      explanation: "Las temporadas de mayor generación de materiales (como Navidad) son oportunidades externas para obtener más recursos."
    },
    {
      id: 14,
      question: "Al justificar un proyecto de upcycling de residuos textiles, ¿qué tipo de estudio académico sería más relevante?",
      options: [
        "Investigaciones sobre el impacto ambiental de la industria textil y beneficios del reuso",
        "Estudios sobre la historia de la moda",
        "Artículos sobre turismo internacional",
        "Investigaciones sobre nutrición infantil"
      ],
      correctAnswer: 0,
      evidence: "Justifica su propuesta a través de una base investigativa, que incluye tanto estudios académicos como información de actualidad.",
      explanation: "Los estudios sobre impacto ambiental textil proporcionan fundamentos científicos sólidos para justificar el upcycling."
    },
    {
      id: 15,
      question: "En un proyecto de upcycling de frascos de vidrio, ¿qué constituye una DEBILIDAD interna?",
      options: [
        "La transparencia del vidrio que permite ver el contenido",
        "La dificultad para romper o cortar vidrio de forma segura sin equipo especializado",
        "El apoyo de los profesores",
        "La tendencia actual hacia productos reutilizables"
      ],
      correctAnswer: 1,
      evidence: "Realiza un análisis DOFA para evaluar las fortalezas, oportunidades, debilidades y amenazas de la solución.",
      explanation: "La dificultad para manipular vidrio sin equipo adecuado es una limitación interna que debe considerarse."
    }
  ];

  // Function to shuffle array
  const shuffleArray = (array) => {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray.slice(0, 10); // Return only 10 questions
  };

  const [questions, setQuestions] = useState(shuffleArray(questionBank));

  // Timer logic
  useEffect(() => {
    if (testStarted && timeLeft > 0 && !testCompleted) {
      timerRef.current = setInterval(() => {
        setTimeLeft(prev => prev - 1);
      }, 1000);
    } else if (timeLeft === 0 && testStarted && !testCompleted) {
      handleTimeUp();
    }

    return () => {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    };
  }, [testStarted, timeLeft, testCompleted]);

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  const handleStartTest = () => {
    if (studentName.trim()) {
      setTestStarted(true);
    }
  };

  const handleTimeUp = () => {
    setTestCompleted(true);
    setShowResult(true);
    calculateScore();
  };

  const handleAnswerSelect = (questionIndex, answerIndex) => {
    if (testCompleted || timeLeft === 0) return;
    setSelectedAnswers(prev => ({
      ...prev,
      [questionIndex]: answerIndex
    }));
  };

  const handleSubmitTest = () => {
    setTestCompleted(true);
    setShowResult(true);
    calculateScore();
  };

  const calculateScore = () => {
    let correct = 0;
    questions.forEach((question, index) => {
      if (selectedAnswers[index] === question.correctAnswer) {
        correct++;
      }
    });
    setScore(correct);
  };

  const handleNewTest = () => {
    setQuestions(shuffleArray(questionBank));
    setSelectedAnswers({});
    setShowResult(false);
    setScore(0);
    setTimeLeft(30 * 60);
    setTestStarted(false);
    setTestCompleted(false);
    setStudentName('');
  };

  const handleDownloadPDF = () => {
    alert('Función de descarga PDF: En un entorno real, esto generaría un PDF con las respuestas del estudiante. Esta funcionalidad requiere bibliotecas adicionales no disponibles en este entorno.');
  };

  if (!testStarted) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100">
        <div className="container mx-auto px-4 py-8 max-w-2xl">
          <div className="bg-white rounded-xl shadow-lg p-8">
            <div className="text-center mb-8">
              <div className="flex items-center justify-center mb-4">
                <RefreshCw className="w-12 h-12 text-emerald-600 mr-3" />
                <h1 className="text-3xl font-bold text-gray-800">Evaluación de Upcycling - Grado 4º</h1>
              </div>
              <p className="text-gray-600 text-lg">
                Análisis DOFA y Justificación Investigativa en Proyectos de Upcycling
              </p>
            </div>

            <div className="space-y-6">
              <div className="flex items-center space-x-3">
                <User className="w-5 h-5 text-emerald-600" />
                <label className="font-medium text-gray-700">Nombre del Estudiante:</label>
              </div>
              <input
                type="text"
                value={studentName}
                onChange={(e) => setStudentName(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                placeholder="Escribe tu nombre completo"
              />

              <div className="flex items-center space-x-3">
                <GraduationCap className="w-5 h-5 text-emerald-600" />
                <label className="font-medium text-gray-700">Grado:</label>
              </div>
              <select
                value={grade}
                onChange={(e) => setGrade(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              >
                <option value="4º">4º Grado</option>
                <option value="5º">5º Grado</option>
                <option value="6º">6º Grado</option>
              </select>

              <div className="flex items-center space-x-3">
                <Calendar className="w-5 h-5 text-emerald-600" />
                <label className="font-medium text-gray-700">Fecha de Presentación:</label>
              </div>
              <input
                type="date"
                value={date}
                onChange={(e) => setDate(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              />

              <button
                onClick={handleStartTest}
                disabled={!studentName.trim()}
                className="w-full bg-emerald-600 text-white py-3 rounded-lg font-semibold hover:bg-emerald-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors duration-200 mt-6"
              >
                Iniciar Evaluación
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (testCompleted) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100">
        <div className="container mx-auto px-4 py-8 max-w-4xl">
          <div className="bg-white rounded-xl shadow-lg p-8">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-800 mb-4">
                {timeLeft === 0 ? '¡Tiempo Agotado!' : 'Evaluación Completada'}
              </h1>
              {timeLeft === 0 && (
                <p className="text-red-600 text-lg font-semibold mb-4">
                  El tiempo de 30 minutos ha finalizado
                </p>
              )}
            </div>

            <div className="mb-8 p-6 bg-emerald-50 rounded-lg">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p className="text-sm text-gray-600">Estudiante:</p>
                  <p className="font-semibold">{studentName}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-600">Grado:</p>
                  <p className="font-semibold">{grade}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-600">Fecha:</p>
                  <p className="font-semibold">{new Date(date).toLocaleDateString('es-ES')}</p>
                </div>
              </div>
              <div className="text-center">
                <p className="text-2xl font-bold text-gray-800">
                  Puntaje Final: {score}/{questions.length}
                </p>
                <p className={`mt-2 font-semibold ${
                  score >= questions.length * 0.7
                    ? 'text-green-600'
                    : score >= questions.length * 0.5
                    ? 'text-yellow-600'
                    : 'text-red-600'
                }`}>
                  {score >= questions.length * 0.7
                    ? '¡Excelente trabajo en upcycling!'
                    : score >= questions.length * 0.5
                    ? 'Buen esfuerzo, sigue practicando'
                    : 'Necesitas repasar más los conceptos de upcycling'}
                </p>
              </div>
            </div>

            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <button
                onClick={handleDownloadPDF}
                className="flex items-center justify-center px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200"
              >
                <Download className="w-5 h-5 mr-2" />
                Descargar PDF
              </button>
              <button
                onClick={handleNewTest}
                className="flex items-center justify-center px-6 py-3 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition-colors duration-200"
              >
                <RefreshCw className="w-5 h-5 mr-2" />
                Nueva Evaluación
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100">
      <div className="container mx-auto px-4 py-4 max-w-4xl">
        {/* Header with timer and student info */}
        <div className="bg-white rounded-xl shadow-lg p-4 mb-6">
          <div className="flex flex-col sm:flex-row justify-between items-center">
            <div className="text-center sm:text-left mb-4 sm:mb-0">
              <p className="font-semibold text-gray-700">{studentName}</p>
              <p className="text-sm text-gray-600">{grade} - {new Date(date).toLocaleDateString('es-ES')}</p>
            </div>
            <div className="flex items-center bg-red-100 text-red-800 px-4 py-2 rounded-lg">
              <Clock className="w-5 h-5 mr-2" />
              <span className="font-bold text-lg">{formatTime(timeLeft)}</span>
            </div>
          </div>
        </div>

        {/* Progress Bar */}
        <div className="mb-6">
          <div className="flex justify-between text-sm text-gray-600 mb-2">
            <span>Pregunta {currentQuestion + 1} de {questions.length}</span>
            <span>Tiempo restante: {formatTime(timeLeft)}</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-3">
            <div 
              className="bg-emerald-600 h-3 rounded-full transition-all duration-500 ease-out"
              style={{ width: `${((currentQuestion) / questions.length) * 100}%` }}
            ></div>
          </div>
        </div>

        {/* Question Card */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div className="flex items-start mb-4">
            <RefreshCw className="w-6 h-6 text-emerald-600 mr-3 mt-1" />
            <h2 className="text-xl font-semibold text-gray-800 leading-relaxed">
              {questions[currentQuestion].question}
            </h2>
          </div>
          
          {/* Evidence Badge */}
          <div className="bg-emerald-50 border-l-4 border-emerald-400 p-4 mb-6 rounded">
            <div className="flex items-center mb-2">
              <User className="w-5 h-5 text-emerald-600 mr-2" />
              <span className="font-medium text-emerald-800">Evidencia de Aprendizaje:</span>
            </div>
            <p className="text-emerald-700 text-sm">{questions[currentQuestion].evidence}</p>
          </div>

          {/* Options */}
          <div className="space-y-3">
            {questions[currentQuestion].options.map((option, index) => (
              <button
                key={index}
                onClick={() => handleAnswerSelect(currentQuestion, index)}
                className={`w-full text-left p-4 rounded-lg border-2 transition-all duration-200 ${
                  selectedAnswers[currentQuestion] === index
                    ? 'border-emerald-500 bg-emerald-50'
                    : 'border-gray-200 hover:border-emerald-300 hover:bg-gray-50'
                }`}
              >
                <div className="flex items-center">
                  <div className={`w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center ${
                    selectedAnswers[currentQuestion] === index
                      ? 'border-emerald-500 bg-emerald-500 text-white'
                      : 'border-gray-300'
                  }`}>
                    {String.fromCharCode(65 + index)}
                  </div>
                  <span className="text-gray-700">{option}</span>
                </div>
              </button>
            ))}
          </div>
        </div>

        {/* Navigation */}
        <div className="flex justify-between">
          <button
            onClick={() => setCurrentQuestion(Math.max(0, currentQuestion - 1))}
            disabled={currentQuestion === 0}
            className="px-6 py-2 text-emerald-600 hover:text-emerald-800 hover:bg-emerald-50 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Anterior
          </button>
          
          {currentQuestion === questions.length - 1 ? (
            <button
              onClick={handleSubmitTest}
              className="px-6 py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition-colors duration-200"
            >
              Finalizar Evaluación
            </button>
          ) : (
            <button
              onClick={() => setCurrentQuestion(currentQuestion + 1)}
              className="px-6 py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition-colors duration-200"
            >
              Siguiente
            </button>
          )}
        </div>
      </div>
    </div>
  );
};

export default App;